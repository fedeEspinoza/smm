<div class="page-header">
  <!--<%= link_to new_estado_medidor_path, class: 'btn btn-primary' do %>
    <span class="glyphicon glyphicon-plus"></span>
    Nueva Medici贸n
  <% end %>-->
  <h4>Mediciones</h4>
</div>
<ol class="breadcrumb">
  <li class="active">
    <%= fa_icon "line-chart", text: "Mediciones" %>
  </li>
</ol>

<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title"><%= fa_icon "search" %> Buscar medici贸n
      <small> (Seleccione un <b>Usuario</b> y a continuaci贸n, uno de sus <b>Medidores</b> asignados)</small>
    </h3>
  </div>
  <div class="panel-body">
    <div class="row">
      <%= label_tag "usuario", "Usuario", class: "col-sm-1 control-label" %>
      <div class="col-sm-6">
        <%= select_tag "usuario", options_from_collection_for_select(Usuario.all, :id, :data_y_domicilio), {prompt: "Seleccione un Usuario", id: "usuario", class: "form-control"}%>
      </div>         
    </div>
    <div class="row">
      <%= label_tag "medidor", "Medidor", class: "col-sm-1 control-label" %>
      <div class="col-sm-5">
        <%= select_tag "medidor", nil, {prompt: "Seleccione un Medidor", id: "medidor", class: "form-control"}%>
      </div>   
      <span id="loading-image" style="display: none;"><img src="<%= asset_path('loading.gif')%>"/></span>      
    </div>
    <div class="form-group">
      <div class="col-sm-offset-2 col-sm-10">
        
      </div>
    </div>
  </div>
</div>

<table class="table table-striped table-bordered table-hover datatable_table" id="mediciones-table" data-source="<%= estado_medidors_path(format: :json) %>">
  <thead>
    <tr>
      <th>Novedad</th>
      <th>Tomaestado</th>
      <th>Estado actual</th>
      <th>Promedio</th>
      <th style="width: 150px">Fecha de medici贸n</th>
      <th style="width: 120px">&nbsp;</th>
    </tr>
  </thead>

  <tbody>
      
  </tbody>
</table>

<script type="text/javascript">
$('document').ready(function(){
  var tabla_mediciones = $('#mediciones-table').dataTable({
      language: { "sUrl": "<%= asset_path('language.es.json') %>"},
      processing: true,
      serverSide: true,
      ajax: $('#mediciones-table').data('source'),
      pagingType: 'full_numbers',
      columnDefs: [
              {
                  "targets": [ 5 ],
                  "searchable": false,
                  "orderable": false
              }
          ]
  });

  $('#usuario').change(function(){
    var usuario_id = parseInt($('#usuario').val(),10);
    $('#loading-image').show();
    $.ajax({
      url: '/usuarios/get_medidores/'+usuario_id,
      type: 'GET'
    })
    .done(function(data){              
      $('#medidor').empty();
      $("#medidor").append(new Option("Seleccione un Medidor", ""));
      var options = '';      
      for(var i in data)
      {
        var id = data[i].id;
        var opcion = data[i].numero+' - '+data[i].marca+' - '+data[i].modelo+', ('+data[i].nombre_tipo_medidor+')';
        $("#medidor").append(new Option(opcion, id));
      }    
      $('#loading-image').hide();
    });
  });

  $('#medidor').change(function(){
    var medidor_id = parseInt($('#medidor').val(),10);
    if (!isNaN(medidor_id))
    {
      // Vuelvo a obtener datos para datatable, esta vez con medidor
      tabla_mediciones.api().ajax.url('<%= estado_medidors_path(format: :json) %>?medidor_id='+medidor_id);
      // Recargo la tabla
      tabla_mediciones.api().ajax.reload();
    }
  });

});
</script>

